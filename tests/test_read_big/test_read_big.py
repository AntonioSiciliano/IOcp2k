import pytest
import AtomicSnap
from AtomicSnap import AtomicSnapshots
import numpy as np
import os

def test_read_big():
    snap = AtomicSnapshots.AtomicSnapshots()
    ucell = np.eye(3) * 18.00
    snap.init('brines-1', ucell, calc_type = 'MD',
              ext_ener = '.ener',    ext_force='.force', ext_pos='.xyz',
              ext_stress='.stress',  ext_cell='.cell_xyz', ext_vel='.vel')


    
    # Hard CODED PART DO NOT MODIFY IT
    STEP = 34020
    K, T, V, Q = [1.326326140 , 714.100886138, -2459.860308507, -2459.494897872]

    positions = np.array([[12.2530237447, 22.7046465098,  6.7278291391],
                        [11.0221314667, 23.3503619681,  6.1592000681],
                        [11.7334696118, 22.7537950587,  5.9241662492],
                        [-3.1630940516, -16.8634174156,  0.4929538737],
                        [-4.4379789512, -15.9870730638,  1.0045656760],
                        [-3.9667265882, -16.3561089788,  0.1601919441],
                        [-6.8405119566, 59.8021135927, 56.4050508595],
                        [-8.4628448122, 59.5933942808, 56.5820225002],
                        [-7.7590781670, 60.2714839080, 56.5599986263],
                        [-0.5028615927, 26.6655070126, 25.2154753278],
                        [ 0.6745456832, 26.5369936989, 26.2311278340],
                        [ 0.1135732983, 27.1536467399, 25.7169124525],
                        [-14.5940139626,  5.9046324147, 16.6095064743],
                        [-15.8836768729,  5.2515785453, 17.0439497517],
                        [-14.9209049451,  5.0937053190, 16.9341230152],
                        [36.2227908287, 35.8888825708, -6.7704125976],
                        [37.2962331278, 36.3100231483, -5.7897655587],
                        [37.1578559507, 35.9634043599, -6.6834501084],
                        [-2.8492719234,  5.4437153803,  7.2805846266],
                        [-2.0410648838,  6.5950095442,  8.3144237139],
                        [-2.7807511496,  6.2227851555,  7.8105781008],
                        [31.3476585650, -6.8511733541, -6.0471785790],
                        [32.5802609667, -7.3345794157, -6.6623546084],
                        [31.9969862938, -7.6051241900, -6.0027594635],
                        [22.2106650118, 15.4706904981, 19.8625204419],
                        [23.6224712105, 15.0961915439, 19.3594402998],
                        [22.6718770686, 15.1470533519, 19.0863781508],
                        [23.3408088794, -5.0184443534, 33.0052845073],
                        [23.3265980463, -4.3361878140, 31.6621746675],
                        [23.9144585402, -4.6036316664, 32.4141855033],
                        [ 2.0715645654, 13.2874297065, -9.9150504911],
                        [ 1.9242345662, 14.1608154370, -8.5607445807],
                        [ 1.3854636344, 13.7678532756, -9.3740557064],
                        [ 9.4931588961,  3.3918120533, 28.8234354550],
                        [10.9920397396,  3.4510793245, 29.2970841910],
                        [10.3911573990,  3.7991603615, 28.6152147878],
                        [12.9371624921, 19.3325424046,  2.0728756637],
                        [14.4302930679, 19.1638185815,  2.3491490617],
                        [13.5743108574, 18.6265046274,  2.1360477588],
                        [ 1.5540632571, -14.2987925551, -0.4015114836],
                        [ 1.2368600670, -12.9224897539, -0.0095041439],
                        [ 1.9727186976, -13.5201955511,  0.0303459015],
                        [38.2688596127, 39.0581181752, -9.7002581489],
                        [38.0696415679, 39.3933525102, -8.2492363588],
                        [38.0104284611, 38.6171169514, -8.8691704525],
                        [18.5381509721,  9.9068710465, -12.8656616857],
                        [17.6151146078, 10.8862820056, -13.5288789373]])


    forces = np.array([[ 0.0064265072, -0.0006805167,  0.0081811911],
                        [-0.0121734733,  0.0058499134,  0.0053413684],
                        [ 0.0034152769, -0.0032925075, -0.0135707613],
                        [-0.0220880982,  0.0198440275, -0.0030384120],
                        [ 0.0237953662, -0.0210525450, -0.0386931119],
                        [-0.0010019264,  0.0002333921,  0.0419132322],
                        [-0.0395443140,  0.0131063977,  0.0077049487],
                        [ 0.0082939062,  0.0031670541, -0.0035936518],
                        [ 0.0267954909, -0.0119185724, -0.0054896276],
                        [-0.0242202467, -0.0216571466, -0.0215398470],
                        [ 0.0056478969,  0.0042736780,  0.0047494227],
                        [-0.0048742084,  0.0299386323,  0.0000458164],
                        [ 0.0183412070,  0.0489671250, -0.0085087127],
                        [ 0.0100411377, -0.0074922039, -0.0020424238],
                        [-0.0203904725, -0.0426981035,  0.0148141153],
                        [-0.0285286989, -0.0027449300, -0.0027205084],
                        [ 0.0030827579, -0.0023883764,  0.0037424846],
                        [ 0.0292828547,  0.0035587784, -0.0039781041],
                        [ 0.0244975301, -0.0399559038, -0.0072753363],
                        [ 0.0062219776, -0.0268151342, -0.0128531881],
                        [-0.0274760507,  0.0862033738,  0.0300277592],
                        [ 0.0093406348, -0.0169750742,  0.0123286344],
                        [ 0.0397950306,  0.0129017148, -0.0461029487],
                        [-0.0494119888,  0.0045988926,  0.0368595525],
                        [-0.0027308122,  0.0054529004,  0.0077122891],
                        [-0.0149770211,  0.0057315356,  0.0004853568],
                        [ 0.0214094663, -0.0145855864, -0.0079361602],
                        [-0.0357573862, -0.0266860440,  0.0402679420],
                        [ 0.0123326625, -0.0018096477,  0.0097128979],
                        [ 0.0213697192,  0.0243726568, -0.0453875422],
                        [-0.0138139852,  0.0117848377,  0.0137366749],
                        [-0.0262639070, -0.0228564242, -0.0467545957],
                        [ 0.0387945631,  0.0114391230,  0.0336600983],
                        [ 0.0189434490,  0.0071989875, -0.0106259670],
                        [-0.0045114506,  0.0018265723, -0.0014676637],
                        [-0.0166341590, -0.0122060193,  0.0116412620],
                        [-0.0244193199,  0.0212712501, -0.0105487756],
                        [-0.0381672096, -0.0265788331, -0.0077915581],
                        [ 0.0642881163,  0.0046244436,  0.0219644479],
                        [ 0.0109712591,  0.0024771200,  0.0035300976],
                        [-0.0159467595,  0.0228142673,  0.0066444022],
                        [ 0.0029109502, -0.0248747981, -0.0095097813],
                        [ 0.0036966445,  0.0015079659, -0.0136484299],
                        [-0.0032334861, -0.0194739182, -0.0067572921],
                        [ 0.0032817906,  0.0142084298,  0.0178382480],
                        [-0.0323595151,  0.0076526435,  0.0062444147],
                        [-0.0044410194,  0.0319070421, -0.0348857346],
                        [ 0.0341785296, -0.0446427108,  0.0328093487],
                        [-0.0169488804, -0.0035204782, -0.0128774217],
                        [ 0.0024211448,  0.0164895685, -0.0012571705],
                        [ 0.0151170062, -0.0147611323,  0.0152157809],
                        [-0.0033728846, -0.0281388080,  0.0168647399],
                        [-0.0397941445,  0.0341533804, -0.0140547055],
                        [ 0.0427293055, -0.0223637447, -0.0014304400],
                        [ 0.0053514368,  0.0027017665,  0.0012718158],
                        [-0.0411418769,  0.0050652050,  0.0465146081],
                        [ 0.0403659324, -0.0077565428, -0.0509216944],
                        [-0.0238055883, -0.0199571126, -0.0171224628],
                        [ 0.0018845025,  0.0145395189, -0.0328448123],
                        [ 0.0123029535,  0.0083841341,  0.0530687671],
                        [ 0.0109041224,  0.0003551887,  0.0063930972],
                        [-0.0043305071,  0.0074499197, -0.0033118215],
                        [-0.0032170820,  0.0046296305, -0.0059159862],
                        [-0.0242606255, -0.0031675739, -0.0099472309],
                        [-0.0034432380,  0.0087323466, -0.0057628165],
                        [ 0.0174877617, -0.0057587072,  0.0159530061],
                        [-0.0264222532, -0.0149876950,  0.0028836179],
                        [ 0.0084813891, -0.0149385985,  0.0163711374],
                        [ 0.0167386861,  0.0327036042, -0.0211101377],
                        [ 0.0023881098,  0.0067914896, -0.0155874251],
                        [-0.0071198854,  0.0075392107,  0.0020302453],
                        [ 0.0015868163, -0.0151143039,  0.0122613538],
                        [-0.0122524492, -0.0074671740, -0.0004700939],
                        [ 0.0019499462, -0.0016253722,  0.0064216730]])


    velocities = np.array([[ 0.00017232,  0.0011909021,  0.0005939230],
                        [ 0.0005707550, -0.0011574818, -0.0004082237],
                        [ 0.0002233464,  0.0000267162,  0.0001009517],
                        [-0.0012692448,  0.0013818264, -0.0011141850],
                        [ 0.0003369565, -0.0009013824,  0.0001629462],
                        [-0.0001656247, -0.0000788886, -0.0005545091],
                        [-0.0001809213,  0.0008420487, -0.0011765573],
                        [ 0.0000574491,  0.0015035278,  0.0001778484],
                        [ 0.0005112488,  0.0005256133,  0.0001508201],
                        [ 0.0017349608,  0.0009177292,  0.0003949268],
                        [ 0.0010667955, -0.0003067561, -0.0026812530],
                        [-0.0001272457,  0.0002289304,  0.0001181535],
                        [ 0.0017717904,  0.0017945605,  0.0010720558],
                        [-0.0006444103, -0.0002294104,  0.0006581876],
                        [-0.0002910342,  0.0002476229, -0.0002316178],
                        [-0.0001061379, -0.0006937883,  0.0002174115],
                        [ 0.0012887081, -0.0005395318, -0.0023058248],
                        [ 0.0001055663,  0.0001144237,  0.0002000098],
                        [-0.0002859223, -0.0010000566,  0.0004590378],
                        [-0.0015232435, -0.0004345053, -0.0001119827],
                        [ 0.0003825675,  0.0001527245, -0.0000221164],
                        [ 0.0007710073,  0.0010119452,  0.0003208320],
                        [-0.0004456988, -0.0001237208,  0.0001058692],
                        [-0.0003417756, -0.0000409349,  0.0000471491],
                        [ 0.0000828403, -0.0003924599,  0.0006586971],
                        [ 0.0014362183,  0.0002287089,  0.0009188261],
                        [-0.0004670025,  0.0004209581, -0.0001157209],
                        [ 0.0004924606,  0.0000720571, -0.0002193930],
                        [-0.0012543016,  0.0001233356, -0.0015401119],
                        [-0.0002619451, -0.0002017972,  0.0001949892],
                        [ 0.0003747671, -0.0019570119, -0.0019695212],
                        [ 0.0000444096,  0.0000578299,  0.0004377051],
                        [-0.0002002803,  0.0001564643,  0.0003039669],
                        [-0.0001375465, -0.0023115430, -0.0012687648],
                        [-0.0018347381,  0.0013334873,  0.0003244373],
                        [ 0.0004266576,  0.0000773628, -0.0004830465],
                        [-0.0012437005,  0.0007508017, -0.0003423529],
                        [ 0.0007316346,  0.0000160736, -0.0001383143],
                        [-0.0001653383, -0.0005395757,  0.0001048473],
                        [-0.0012930700, -0.0004180433, -0.0005951771],
                        [-0.0004447054,  0.0006356106,  0.0000998934],
                        [-0.0003360182, -0.0003331587,  0.0001129133],
                        [-0.0010561693,  0.0014111322, -0.0002122298],
                        [-0.0002521299,  0.0009758632, -0.0003159167],
                        [ 0.0000206541, -0.0001551256, -0.0002042031],
                        [ 0.0009944386, -0.0001991112,  0.0013735317],
                        [ 0.0005982061,  0.0006734373, -0.0008206862],
                        [-0.0002383019,  0.0004483436,  0.0001234595],
                        [ 0.0001122474, -0.0021869637,  0.0008971845],
                        [ 0.0008216830, -0.0000181987, -0.0001790129],
                        [-0.0002531881, -0.0002268604, -0.0003062410],
                        [-0.0014178043,  0.0000209394, -0.0004289789],
                        [ 0.0028585012, -0.0011842382, -0.0008549307]])

    # xx [bar]   xy [bar]   xz [bar]   yx [bar]   yy [bar]   yz [bar]   zx [bar]   zy [bar]   zz [bar]
    stress = np.array([[90.3008423459,      75.7507473758, -231.7035674868],
                       [75.7507473758,     645.2529079323, -3785.9359910111],
                       [-231.7035674868, -3785.9359910111, 2315.3709711332]])
    
    # Convert the step 
    STEP -= 34000
    # END OF THE HARD CODED PART
    
    if np.abs(snap.energies[STEP - 1] - V) > 1e-8:
        raise ValueError('The energy is not correct')

    if np.abs(snap.potential_energies[STEP - 1] - V) > 1e-8:
        raise ValueError('The energy is not correct')

    if np.abs(snap.temperatures[STEP - 1] - T) > 1e-8:
        raise ValueError('The temperature is not correct')

    if np.abs(snap.kinetic_energies[STEP - 1] - K) > 1e-8:
        raise ValueError('The temperature is not correct')

    if np.abs(snap.cons_quant[STEP - 1] - Q) > 1e-8:
        raise ValueError('The temperature is not correct')

    # Read only a part of the positons forces and velocities
    if np.abs(snap.positions[STEP - 1, np.arange(len(positions[:,0])), :] - positions).max() > 1e-10:
        raise ValueError('The positions are not correct')
    
    if np.abs(snap.forces[STEP - 1, np.arange(len(forces[:,0])), :] - forces).max() > 1e-8:
        raise ValueError('The forces are not correct')

    if np.abs(snap.velocities[STEP - 1, np.arange(len(velocities[:,0])), :] - velocities).max() > 1e-8:
        raise ValueError('The velocities are not correct')

    # Check the stress tensor
    if np.abs(snap.stresses[STEP - 1,:,:] * AtomicSnapshots.BAR_TO_HA_BOHR3**-1 - stress).max() > 1e-8:
        raise ValueError('The stress is not correct')

    
    
if __name__ == "__main__":
    
    total_path = os.path.dirname(os.path.abspath(__file__))
    os.chdir(total_path)
    
    test_read_big()
